<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="FeelSync - Gamified Mental Health Detection Platform for Adolescents">
    <title>{% block title %}FeelSync - Mental Health Games{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
    {% block extra_css %}{% endblock %}
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #84fab0;
            --warning-color: #f093fb;
            --danger-color: #fa709a;
            --success-color: #4facfe;
            --dark-color: #2d3748;
            --light-gray: #f7fafc;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--light-gray) 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        
        .navbar-brand {
            font-weight: bold;
            color: var(--primary-color) !important;
            font-size: 1.5rem;
        }
        
        .nav-link {
            color: var(--dark-color) !important;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .nav-link:hover {
            color: var(--primary-color) !important;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .game-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .alert {
            border: none;
            border-radius: 10px;
            border-left: 4px solid;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-left-color: var(--primary-color);
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #fff3e0 0%, #fce4ec 100%);
            border-left-color: var(--warning-color);
        }
        
        .alert-success {
            background: linear-gradient(135deg, #e8f5e8 0%, #e0f2f1 100%);
            border-left-color: var(--success-color);
        }
        
        .footer {
            background: var(--dark-color);
            color: white;
            margin-top: 50px;
            padding: 30px 0;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .mental-health-score {
            padding: 20px;
            border-radius: 15px;
            margin: 10px 0;
            text-align: center;
            color: white;
            font-weight: bold;
        }
        
        .score-low { background: linear-gradient(135deg, var(--success-color) 0%, #00b09b 100%); }
        .score-moderate { background: linear-gradient(135deg, var(--warning-color) 0%, #f093fb 100%); }
        .score-high { background: linear-gradient(135deg, var(--danger-color) 0%, #ff6b6b 100%); }
        
        .progress {
            height: 8px;
            border-radius: 10px;
        }
        
        .progress-bar {
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-brain me-2"></i>FeelSync
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    {% if session.user_id %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard') }}">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="gamesDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-gamepad me-1"></i>Games
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('catch_thought_game') }}">
                                <i class="fas fa-cloud me-2"></i>Catch the Thought
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('stat_balance_game') }}">
                                <i class="fas fa-balance-scale me-2"></i>Stat Balance
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('decision_maker_game') }}">
                                <i class="fas fa-crossroads me-2"></i>Decision Maker
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('personal_analysis') }}">
                            <i class="fas fa-chart-line me-1"></i>My Analysis
                        </a>
                    </li>
                    {% endif %}
                </ul>
                
                <ul class="navbar-nav">
                    {% if session.user_id %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>Account
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showProfile()">
                                <i class="fas fa-user-cog me-2"></i>Profile
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="showPrivacySettings()">
                                <i class="fas fa-shield-alt me-2"></i>Privacy
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('login') }}">
                            <i class="fas fa-sign-in-alt me-1"></i>Login
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link btn btn-primary text-white ms-2 px-3" href="{{ url_for('register') }}">
                            <i class="fas fa-user-plus me-1"></i>Sign Up
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="container mt-3">
            {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                {% if category == 'error' %}
                    <i class="fas fa-exclamation-triangle me-2"></i>
                {% elif category == 'success' %}
                    <i class="fas fa-check-circle me-2"></i>
                {% elif category == 'warning' %}
                    <i class="fas fa-exclamation-circle me-2"></i>
                {% elif category == 'info' %}
                    <i class="fas fa-info-circle me-2"></i>
                {% endif %}
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main class="container-fluid">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer mt-auto">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="fas fa-brain me-2"></i>FeelSync</h5>
                    <p class="mb-2">Gamified platform for early detection and management of adolescent mental health issues.</p>
                    <small class="text-muted">Capstone Project - Computer Science Engineering</small>
                </div>
                <div class="col-md-3">
                    <h6>Resources</h6>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-light text-decoration-none" onclick="showHelp()">
                            <i class="fas fa-question-circle me-1"></i>Help & Support
                        </a></li>
                        <li><a href="#" class="text-light text-decoration-none" onclick="showPrivacy()">
                            <i class="fas fa-shield-alt me-1"></i>Privacy Policy
                        </a></li>
                        <li><a href="#" class="text-light text-decoration-none" onclick="showConsent()">
                            <i class="fas fa-file-contract me-1"></i>Consent Info
                        </a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h6>Emergency Resources</h6>
                    <ul class="list-unstyled">
                        <li><small class="text-light">Crisis Hotline: 988</small></li>
                        <li><small class="text-light">Emergency: 911</small></li>
                        <li><small class="text-light">Text Support: 741741</small></li>
                    </ul>
                </div>
            </div>
            <hr class="my-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <small class="text-muted">© 2024 FeelSync Team. Educational Project.</small>
                </div>
                <div class="col-md-6 text-end">
                    <small class="text-muted">
                        <strong>Disclaimer:</strong> Not a diagnostic tool. For educational purposes only.
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Modals -->
    
    <!-- Privacy Settings Modal -->
    <div class="modal fade" id="privacyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-shield-alt me-2"></i>Privacy Settings
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Your privacy is important to us. Review and update your data sharing preferences.
                    </div>
                    
                    <h6>Data Collection Consent</h6>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="behavioralData" checked disabled>
                        <label class="form-check-label" for="behavioralData">
                            <strong>Behavioral Data Collection</strong> (Required)
                            <small class="d-block text-muted">Gameplay patterns for mental health analysis</small>
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="researchData">
                        <label class="form-check-label" for="researchData">
                            <strong>Research Participation</strong> (Optional)
                            <small class="d-block text-muted">Anonymous data for academic research</small>
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="therapistAccess">
                        <label class="form-check-label" for="therapistAccess">
                            <strong>Therapist Access</strong> (Optional)
                            <small class="d-block text-muted">Allow authorized therapists to view your data</small>
                        </label>
                    </div>
                    
                    <hr>
                    <h6>Data Management</h6>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="exportData()">
                        <i class="fas fa-download me-1"></i>Export My Data
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="requestDataDeletion()">
                        <i class="fas fa-trash me-1"></i>Delete My Account
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePrivacySettings()">
                        <i class="fas fa-save me-1"></i>Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-question-circle me-2"></i>Help & Support
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="accordion" id="helpAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                    How does FeelSync work?
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    FeelSync uses interactive games to observe your behavioral patterns and decision-making processes. 
                                    Our AI analyzes these patterns to provide insights about potential mental health indicators, 
                                    helping with early awareness and self-reflection.
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                    Is this a diagnostic tool?
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <strong>No.</strong> FeelSync is NOT a diagnostic tool and should not be used to diagnose mental health conditions. 
                                    It's designed for educational purposes and self-awareness. If you have concerns about your mental health, 
                                    please consult with a qualified healthcare professional.
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingThree">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                                    How is my data protected?
                                </button>
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    Your data is encrypted and stored securely. We use anonymization techniques and 
                                    never share identifiable information without explicit consent. You can export or 
                                    delete your data at any time through your privacy settings.
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFour">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour">
                                    What if I need immediate help?
                                </button>
                            </h2>
                            <div id="collapseFour" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    If you're experiencing a mental health crisis or thoughts of self-harm:
                                    <ul class="mt-2">
                                        <li><strong>Call 988</strong> - Suicide & Crisis Lifeline (US)</li>
                                        <li><strong>Call 911</strong> - Emergency services</li>
                                        <li><strong>Text HOME to 741741</strong> - Crisis Text Line</li>
                                        <li>Go to your nearest emergency room</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" 
         style="background: rgba(0,0,0,0.5); z-index: 9999;">
        <div class="position-absolute top-50 start-50 translate-middle text-center text-white">
            <div class="loading-spinner mb-3"></div>
            <div>Processing...</div>
        </div>
    </div>

    <!-- JavaScript -->
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Global JavaScript functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('d-none');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('d-none');
        }
        
        function showPrivacySettings() {
            new bootstrap.Modal(document.getElementById('privacyModal')).show();
        }
        
        function showHelp() {
            new bootstrap.Modal(document.getElementById('helpModal')).show();
        }
        
        function showProfile() {
            // TODO: Implement profile modal
            alert('Profile settings coming soon!');
        }
        
        function showPrivacy() {
            showPrivacySettings();
        }
        
        function showConsent() {
            // TODO: Implement consent information modal
            alert('Consent information modal coming soon!');
        }
        
        function savePrivacySettings() {
            showLoading();
            
            const settings = {
                research_participation: document.getElementById('researchData').checked,
                therapist_access: document.getElementById('therapistAccess').checked
            };
            
            fetch('/api/privacy-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('privacyModal')).hide();
                    showAlert('Privacy settings updated successfully!', 'success');
                } else {
                    showAlert('Error updating privacy settings: ' + data.error, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                showAlert('Network error occurred', 'error');
            });
        }
        
        function exportData() {
            showLoading();
            
            fetch('/api/export-data', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Export failed');
            })
            .then(blob => {
                hideLoading();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'feelsync-data-export.json';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showAlert('Data export completed!', 'success');
            })
            .catch(error => {
                hideLoading();
                showAlert('Export failed: ' + error.message, 'error');
            });
        }
        
        function requestDataDeletion() {
            if (confirm('Are you sure you want to delete all your data? This action cannot be undone.')) {
                showLoading();
                
                fetch('/api/delete-account', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        alert('Account deletion requested. You will be logged out.');
                        window.location.href = '/logout';
                    } else {
                        showAlert('Error requesting account deletion: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Network error occurred', 'error');
                });
            }
        }
        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // Initialize tooltips and popovers
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl);
            });
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
